<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynamic Story Generation and Text-to-Speech</title>

    <style>
        #content {
            max-height: 500px;
            overflow-y: auto;
            border: 1px solid #ccc;
            padding: 10px;
        }

        .chunk {
            margin-bottom: 20px;
        }
    </style>
</head>

<body>
    <h1>Story Generator and Text-to-Speech</h1>

    <!-- Speaker Selection -->
    <select id="speakerSelect">
        <option value="">Select a speaker</option>
    </select>

    <!-- New Speaker Section -->
    <div id="newSpeakerSection">
        <label for="speakerName">Enter Speaker Name:</label>
        <input type="text" id="speakerName" name="speakerName">

        <div id="recordingSection">
            <h2>Record Audio</h2>
            <button id="startRecord">Start Recording</button>
            <button id="stopRecord" disabled>Stop Recording</button>
            <audio id="audioPlayback" controls style="display:none;"></audio>
        </div>

        <div id="uploadSection">
            <h2>Upload Audio</h2>
            <input type="file" id="audioFileInput" accept="audio/*">
        </div>
    </div>

    <button id="generateStoryButton" type="button">Generate Story</button>
    <div id="content"></div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        $(document).ready(function () {
            const generateStoryButton = $('#generateStoryButton');
            const content = $('#content');
            const speakerSelect = $('#speakerSelect');
            const speakerNameInput = $('#speakerName');
            const audioFileInput = $('#audioFileInput');
            const startRecordButton = $('#startRecord');
            const stopRecordButton = $('#stopRecord');
            const audioPlayback = $('#audioPlayback');
            const newSpeakerSection = $('#newSpeakerSection');

            let audioPlayers = [];
            let mediaRecorder;
            let audioChunks = [];

            const backendUrl = 'http://127.0.0.1:5000';

            // Load speaker options
            function loadSpeakers() {
                $.getJSON(`${backendUrl}/speaker`, function (data) {
                    speakerSelect.empty().append(
                        '<option value="">Select a speaker</option><option value="new">Create new speaker</option>'
                    );
                    if (data.speakers && data.speakers.length > 0) {
                        data.speakers.forEach(function (speaker) {
                            speakerSelect.append($('<option></option>').val(speaker).text(
                                speaker));
                        });
                    }
                });
            }

            loadSpeakers();

            // Handle speaker selection
            speakerSelect.on('change', function () {
                if (speakerSelect.val() === "new") {
                    speakerNameInput.prop('disabled', false);
                    audioFileInput.prop('disabled', false);
                    startRecordButton.prop('disabled', false);
                } else {
                    speakerNameInput.prop('disabled', true).val('');
                    audioFileInput.prop('disabled', true);
                    startRecordButton.prop('disabled', true);
                }
            });

            // Handle speaker name input
            speakerNameInput.on('input', function () {
                if (speakerNameInput.val().length > 0) {
                    speakerSelect.val("new").prop('disabled', true);
                } else {
                    speakerSelect.prop('disabled', false);
                }
            });

            // Recording functionality
            startRecordButton.on('click', async function () {
                audioChunks = [];
                const stream = await navigator.mediaDevices.getUserMedia({
                    audio: true
                });
                mediaRecorder = new MediaRecorder(stream);
                mediaRecorder.ondataavailable = event => audioChunks.push(event.data);
                mediaRecorder.onstop = () => {
                    const audioBlob = new Blob(audioChunks, {
                        type: 'audio/wav'
                    });
                    const audioUrl = URL.createObjectURL(audioBlob);
                    audioPlayback.attr('src', audioUrl).show();
                };
                mediaRecorder.start();
                startRecordButton.prop('disabled', true);
                stopRecordButton.prop('disabled', false);
            });

            stopRecordButton.on('click', function () {
                mediaRecorder.stop();
                startRecordButton.prop('disabled', false);
                stopRecordButton.prop('disabled', true);
            });

            // Generate story
            generateStoryButton.on('click', function () {
                const selectedSpeaker = speakerSelect.val();
                const speakerName = speakerNameInput.val();
                const audioFile = audioFileInput[0].files[0];

                if (selectedSpeaker === "new") {
                    if (!speakerName || (!audioFile && audioChunks.length === 0)) {
                        alert('Please enter a speaker name and provide an audio file or recording.');
                        return;
                    }

                    const formData = new FormData();
                    formData.append('speakerName', speakerName);
                    if (audioFile) {
                        formData.append('audioFile', audioFile);
                    } else if (audioChunks.length > 0) {
                        const audioBlob = new Blob(audioChunks, {
                            type: 'audio/wav'
                        });
                        formData.append('audioFile', audioBlob, 'recording.wav');
                    }

                    // Save audio and update speaker.json
                    fetch(`${backendUrl}/save-audio`, {
                            method: 'POST',
                            body: formData
                        }).then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                alert('Audio and speaker saved successfully!');
                                startStoryGeneration(speakerName);
                            } else {
                                alert('Error: ' + data.error);
                            }
                        });
                } else {
                    // Use existing speaker
                    startStoryGeneration(selectedSpeaker);
                }
            });

            function startStoryGeneration(speaker) {
                generateStoryButton.prop('disabled', true);
                content.empty();

                $.ajax({
                    url: `${backendUrl}/generate-story`,
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        topic: "happy animals",
                        age_range: "3 and 6",
                        word_count: 200,
                        speaker: speaker,
                        language: 'en'
                    }),
                    success: function (data) {
                        if (data.success) {
                            content.html(`<h2>${data.title}</h2>`);
                            processAudio(speaker, data.title);
                        } else {
                            content.html('<p>Error generating story. Please try again.</p>');
                        }
                    },
                    error: function () {
                        content.html('<p>Error generating story. Please try again.</p>');
                    },
                    complete: function () {
                        generateStoryButton.prop('disabled', false);
                    }
                });
            }

            function processAudio(speaker, title) {
                fetch(`${backendUrl}/process?speaker=${speaker}&title=${title}&generate_audio=false`)
                    .then(response => response.json())
                    .then(data => {
                        content.empty();
                        audioPlayers = [];

                        data.forEach((item, index) => {
                            const chunkDiv = document.createElement('div');
                            chunkDiv.className = 'chunk';

                            const audioPlayer = document.createElement('audio');
                            audioPlayer.controls = true;

                            // Append the audio player and text to the chunkDiv
                            chunkDiv.appendChild(audioPlayer);
                            chunkDiv.innerHTML += `<p>${item.text}</p>`;
                            content.append(chunkDiv);

                            audioPlayers.push(audioPlayer);
                        });

                        // Trigger audio generation after text is displayed
                        generateAudioForChunks(speaker, title);
                    })
                    .catch(error => {
                        console.error('Error fetching text chunks:', error);
                        content.append(
                            '<p>An error occurred while processing the text. Please try again.</p>');
                    });
            }

            function generateAudioForChunks(speaker, title) {
                fetch(`${backendUrl}/process?speaker=${speaker}&title=${title}&generate_audio=true`)
                    .then(response => response.json())
                    .then(data => {
                        data.forEach((item, index) => {
                            if (item.audio) {
                                // Update the corresponding audio player's src
                                audioPlayers[index].src = `${backendUrl}${item.audio}`;
                                audioPlayers[index]
                                    .load(); // Ensure the audio player is reloaded with the new source
                            }
                        });
                        console.log('Audio generation complete');
                    })
                    .catch(error => {
                        console.error('Error generating audio:', error);
                    });
            }
        });
    </script>

</body>

</html>