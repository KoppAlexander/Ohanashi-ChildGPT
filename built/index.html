<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynamic Text-to-Speech</title>

    <style>
        #content {
            max-height: 500px;
            overflow-y: auto;
            border: 1px solid #ccc;
            padding: 10px;
        }

        .chunk {
            margin-bottom: 20px;
        }
    </style>
</head>

<body>
    <h1>Androcles and the Lion</h1>
    <button id="startButton" type="button">Start Processing</button>
    <div id="content"></div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        $(document).ready(function () {
            const startButton = $('#startButton');
            const content = $('#content');
            const loadingMessage = $('<span id="loadingMessage">Data processing ...</span>').hide();
            startButton.after(loadingMessage); // Add loading message after the button

            let eventSource;
            let audioPlayers = [];

            startButton.on('click', function (event) {
                event.preventDefault();
                if (eventSource) {
                    eventSource.close();
                }

                content.empty();
                audioPlayers = [];
                loadingMessage.show(); // Show loading message

                eventSource = new EventSource('http://127.0.0.1:5000/process');

                eventSource.onmessage = function (event) {
                    const data = JSON.parse(event.data);
                    console.log("Received data:", data);
                    const chunkDiv = document.createElement('div');
                    chunkDiv.className = 'chunk';
                    chunkDiv.innerHTML = `
                    <p>${data.text}</p>
                    <audio controls>
                        <source src="${data.audio}" type="audio/wav">
                        Your browser does not support the audio element.
                    </audio>
                `;
                    content.append(chunkDiv);

                    const audioPlayer = chunkDiv.querySelector('audio');
                    audioPlayers.push(audioPlayer);

                    audioPlayer.addEventListener('ended', function () {
                        const currentIndex = audioPlayers.indexOf(this);
                        if (currentIndex < audioPlayers.length - 1) {
                            setTimeout(() => {
                                audioPlayers[currentIndex + 1].play();
                            }, 1000); // 1 second delay
                        }
                    });
                };

                eventSource.onerror = function (error) {
                    console.error('EventSource failed:', error);
                    eventSource.close();
                    loadingMessage.hide(); // Hide loading message on error
                };

                eventSource.addEventListener('complete', function () {
                    loadingMessage.hide(); // Hide loading message when processing is complete
                });
            });
        });
    </script>
</body>

</html>