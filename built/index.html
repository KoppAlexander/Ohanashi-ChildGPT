<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynamic Text-to-Speech</title>

    <style>
        #content {
            max-height: 500px;
            overflow-y: auto;
            border: 1px solid #ccc;
            padding: 10px;
        }

        .chunk {
            margin-bottom: 20px;
        }
    </style>
</head>

<body>
    <h1>Androcles and the Lion</h1>
    <select id="speakerSelect">
        <option value="">Select a speaker</option>
    </select>
    <button id="startButton" type="button">Start Processing</button>
    <div id="content"></div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        $(document).ready(function () {
            const startButton = $('#startButton');
            const content = $('#content');

            const speakerSelect = $('#speakerSelect');

            const loadingMessage = $('<span id="loadingMessage">Data processing ...</span>').hide();
            startButton.after(loadingMessage);

            let eventSource;
            let audioPlayers = [];

            const backendUrl = 'http://127.0.0.1:5000';

            // Load speaker options
            $.getJSON(`${backendUrl}/speaker`, function (data) {
                console.log("Received speaker data:", data);
                if (data.speakers && data.speakers.length > 0) {
                    data.speakers.forEach(function (speaker) {
                        speakerSelect.append($('<option></option>').val(speaker).text(speaker));
                    });
                } else {
                    console.log("No speakers found in the data.");
                }
            }).fail(function (jqxhr, textStatus, error) {
                console.log("Request Failed: " + textStatus + ", " + error);
            });

            startButton.on('click', function (event) {
                event.preventDefault();
                const selectedSpeaker = speakerSelect.val();
                if (!selectedSpeaker) {
                    alert('Please select a speaker');
                    return;
                }

                if (eventSource) {
                    eventSource.close();
                }

                content.empty();
                audioPlayers = [];
                loadingMessage.show();

                eventSource = new EventSource(
                    `${backendUrl}/process?speaker=${selectedSpeaker}`);


                eventSource.onmessage = function (event) {
                    const data = JSON.parse(event.data);
                    console.log("Received data:", data);
                    const chunkDiv = document.createElement('div');
                    chunkDiv.className = 'chunk';
                    chunkDiv.innerHTML = `
                <p>${data.text}</p>
                <audio controls>
                    <source src="${backendUrl}${data.audio}" type="audio/wav">
                    Your browser does not support the audio element.
                </audio>
            `;
                    content.append(chunkDiv);

                    const audioPlayer = chunkDiv.querySelector('audio');
                    audioPlayers.push(audioPlayer);

                    audioPlayer.addEventListener('ended', function () {
                        const currentIndex = audioPlayers.indexOf(this);
                        if (currentIndex < audioPlayers.length - 1) {
                            setTimeout(() => {
                                audioPlayers[currentIndex + 1].play();
                            }, 1000);
                        }
                    });
                };

                eventSource.onerror = function (error) {
                    console.log('EventSource connection closed or encountered an error');
                    eventSource.close();
                    loadingMessage.hide();

                    if (content.children().length === 0) {
                        content.append(
                            '<p>An error occurred while processing the text. Please try again.</p>'
                        );
                    }
                };

                eventSource.addEventListener('complete', function () {
                    console.log('Processing complete');
                    eventSource.close();
                    loadingMessage.hide();
                });
            });
        });
    </script>
</body>

</html>